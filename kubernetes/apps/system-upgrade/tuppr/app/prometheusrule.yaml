---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: tuppr-alerts
  namespace: system-upgrade
spec:
  groups:
    - name: tuppr.talos.rules
      interval: 1m
      rules:
        - alert: TupprTalosUpgradeFailed
          expr: |
            tuppr_talos_upgrade_phase{phase="Failed"} == 1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Talos upgrade has failed"
            description: "Tuppr Talos upgrade is in Failed state for cluster {{ $labels.cluster }}"

        - alert: TupprTalosUpgradeStuck
          expr: |
            tuppr_talos_upgrade_phase{phase="Running"} == 1
            and
            changes(tuppr_talos_upgrade_nodes_completed[30m]) == 0
          for: 30m
          labels:
            severity: warning
          annotations:
            summary: "Talos upgrade appears stuck"
            description: "Tuppr Talos upgrade has not progressed in 30 minutes. Current progress: {{ $value }} nodes completed."

        - alert: TupprHealthCheckFailing
          expr: |
            rate(tuppr_health_check_failures_total[5m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Tuppr health checks are failing"
            description: "Health check {{ $labels.check }} is failing at {{ $value }} failures/sec"

